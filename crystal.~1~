#!/usr/bin/env sh

# Status Bar
[ "$STATUS_BAR" ] || export STATUS_BAR=yabaar
# BSPWM Padding
top_padding=35
hidden_windows=/tmp/crystal_0$(wmctrl -d | grep "\*" | cut -d ' ' -f 1)
mode="$hidden_windows"_mono
mode=/tmp/fullscreen

# Statasbar Launching
launch_bar() { $STATUS_BAR & }

hide_nodes() {
  xdo id -rd | tee "$hidden_windows"
  [ -s "$hidden_windows" ] && cat "$hidden_windows" | xargs xdo hide
}

unhide_nodes() {
  cat "$hidden_windows" | xargs xdo show
  : > "$hidden_windows"
}

bspc config borderless_monocle true
bspc config gapless_monocle true

case $1 in

  --navigate)
    # Regular navigations
    if [ "$2" = "next" ]; then
      bspc node -f next.local && exit 1
    else
      bspc node -f prev.local && exit 1
    fi

    # Edge cases
    [ ! -f "$hidden_windows" ] && exit 1
    [ "$(wc -l < "$hidden_windows")" = 0 ] && exit 1

    # This is where the fun begins

    currentWindow=$(xdo id)
    xdo hide

    if [ "$2" = "next" ]; then
      tail -1 "$hidden_windows" | xargs xdo show
      sed -i '$d' "$hidden_windows"
      printf "%s\n%s" "$currentWindow" "$(cat "$hidden_windows")" > "$hidden_windows"
      # sed -i "1i$currentWindow" "$hidden_windows"
    else
      head -1 "$hidden_windows" | xargs xdo show
      sed -i '1d' "$hidden_windows"
      echo "$currentWindow" >> "$hidden_windows"
    fi
    ;;

  --toggle)

    xdo id || exit 1

    if [ "$2" = "fullscreen" ]; then
      if [ -s "$mode" ]; then
        : > "$mode"
        xdo show -a yabar
        unhide_nodes
        bspc desktop -l tiled
        bspc config top_padding $top_padding
      else
        echo mono > "$mode"
        xdo hide -a yabar
        hide_nodes
        bspc desktop -l monocle
        bspc config top_padding 0
      fi
    else # Mono mode

      if [ -s "$mode" ]; then
        : > "$mode"
        unhide_nodes
      else
        echo mono > "$mode"
        hide_nodes
      fi

      bspc desktop -l next

    fi

    bspc node -f prev.local
    bspc node -n biggest.local

    ;;

  --close)
    xdo close
    if [ -s "$hidden_windows" ]; then
      tail -1 "$hidden_windows" | xargs xdo show
      sed -i '$d' "$hidden_windows"
    fi
    ;;
  *) : ;;

esac
